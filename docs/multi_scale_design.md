# 多时间尺度预测模型设计文档 (Multi-Scale Prediction Design)

## 1. 核心理念
构建一个“多专家集成系统” (Multi-Expert Ensemble System)，利用不同时间周期的数据特性，共同预测同一个目标：**未来 4 小时的价格涨跌幅**。

*   **15min (Micro)**: 捕捉微观结构、瞬间爆发力、短期动量。
*   **1h (Intraday)**: 捕捉日内波段、小时级支撑压力。
*   **4h (Base)**: 捕捉主趋势、基准信号。
*   **1d (Context)**: 提供宏观背景（Regime），用于过滤或加权。

## 2. 预测目标统一 (Unified Target)
所有模型的目标变量 (Label) 必须物理一致，即 **未来 4 小时的收益率**。

| 模型周期 | 输入特征 (Features) | 目标 Label 定义 (Qlib 表达式) |
| :--- | :--- | :--- |
| **15 min** | 过去 N 根 15m K线 | `Ref($close, -16) / $close - 1` (未来16根k线累计收益) |
| **1 hour** | 过去 N 根 1h K线 | `Ref($close, -4) / $close - 1` (未来4根k线累计收益) |
| **4 hour** | 过去 N 根 4h K线 | `Ref($close, -1) / $close - 1` (未来1根k线收益) |

## 3. 数据挑战：长短周期数据对齐 (Data Alignment & Handling Missing History)

### 问题描述
由于交易所 API 或数据源限制，高频数据（如 15min）的可获取历史通常比低频数据（如 4h, 1d）短得多。
*   例如：4H 可能有 5 年数据，而 15min 只有最近 1 年数据。

### 解决方案：动态回退机制 (Dynamic Fallback Mechanism)

在训练和回测时，必须处理“不完整的时间窗口”。我们采用 **“有啥用啥，缺失回退”** 的策略。

#### A. 训练阶段 (Training)
由于需要大量样本训练，仅使用**所有周期数据的交集 (Intersection)** 时间段进行“全模型”训练可能导致样本太少。
**策略**：
1.  **独立训练 (Independent Training)**: 每个时间尺度的模型（15m, 1h, 4h）使用其各自**最大可用**的数据历史进行独立训练。
    *   4H 模型：使用 2020-2025 数据训练。
    *   15m 模型：使用 2024-2025 数据训练。
2.  **不强求同期**: 只要通过验证集测试即可。

#### B. 推理/回测阶段 (Inference/Backtest)
在回测历史数据时，会遇到早期只有 4H 数据，后期才有 15min 数据的情况。
**策略**：**动态权重调整 (Dynamic Weighting)**

集成公式：
$$S_{final} = \frac{\sum (w_i \cdot S_i \cdot I_i)}{\sum (w_i \cdot I_i)}$$

其中 $I_i$ 是指示函数：如果该时间点模型 $i$ 有数据输出，则为 1，否则为 0。

*   **阶段 1 (远古时期 - 仅 4H 可用)**:
    *   $S_{final} = 1.0 \times S_{4h}$ (完全依赖 4H 模型)
*   **阶段 2 (中期 - 4H + 1H 可用)**:
    *   $S_{final} = 0.6 \times S_{4h} + 0.4 \times S_{1h}$ (重新归一化权重)
*   **阶段 3 (近期 - 全数据可用)**:
    *   $S_{final} = 0.5 \times S_{4h} + 0.3 \times S_{1h} + 0.2 \times S_{15m}$

### C. 数据获取与对齐实施细节
1.  **存储分离**: 不同频率的数据存储在不同的 Qlib Dataset 目录中 (`data/qlib_data/crypto_15m`, `crypto_1h` 等)。
2.  **时间索引对齐**: 在最终集成时，以 **4H 时间戳** 为主键。
    *   对于 15min 模型，取这一段 4H 窗口**结束时刻**（或开始时刻，需统一）的那个预测值。
    *   如果该时刻缺失 15min 数据，则标记为 `NaN`，触发动态权重逻辑。

## 4. 实施步骤
1.  **下载**: 尽可能下载各自最长历史的数据。
2.  **构建**: 分别构建三个 Qlib BIN 数据集。
3.  **训练**: 分别训练三个 LightGBM 模型。
4.  **策略**: 编写 `MultiScaleStrategy`，内置动态权重逻辑，处理从 2020 年回测到 2025 年时的数据源切换问题。
